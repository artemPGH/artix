<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ARTIX</title>

<style>
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:radial-gradient(circle at top,#0b1220,#020308 70%);color:#e5e7eb}
  .app{height:100%;display:flex;padding:14px}
  .panel{flex:1;background:rgba(8,10,26,.96);border-radius:18px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 0 40px rgba(0,0,0,.8)}
  .header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center;gap:12px}
  .left{min-width:0}
  .title{letter-spacing:.18em;font-weight:900;text-transform:uppercase}
  .subtitle{font-size:12px;opacity:.6;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70vw}
  .status{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);opacity:.9;white-space:nowrap}
  .chat{flex:1;padding:16px;overflow-y:auto;background:rgba(15,23,42,.92)}
  .msg{margin-bottom:10px;display:flex}
  .msg.user{justify-content:flex-end}
  .msg.bot{justify-content:flex-start}
  .bubble{max-width:90%;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.08);white-space:pre-wrap;word-break:break-word}
  .user .bubble{background:linear-gradient(135deg,#2563eb55,#020617)}
  .bot .bubble{background:linear-gradient(135deg,#10b98133,#020617)}
  .meta{margin-top:8px;font-size:11px;opacity:.65}
  pre{background:#020617;border:1px solid rgba(148,163,184,.35);padding:12px;border-radius:12px;overflow-x:auto;margin:10px 0 0}
  code{font-family:ui-monospace,Consolas,monospace;font-size:13px}
  .input{padding:12px;border-top:1px solid rgba(255,255,255,.06);display:flex;gap:10px;align-items:flex-end}
  textarea{flex:1;min-height:48px;max-height:220px;resize:none;background:#020617;color:#e5e7eb;border:1px solid rgba(148,163,184,.4);border-radius:12px;padding:10px;outline:none;line-height:1.35}
  button{background:linear-gradient(135deg,#4f46e5,#06b6d4);border:none;color:#fff;font-weight:900;border-radius:12px;padding:10px 16px;cursor:pointer;white-space:nowrap}
  button:hover{opacity:.92}
  .tools{display:flex;gap:8px;align-items:center}
  .btn-mini{background:rgba(2,6,23,.25);border:1px solid rgba(148,163,184,.25);padding:7px 10px;border-radius:999px;font-weight:800}
  .btn-mini:hover{border-color:rgba(148,163,184,.55)}
</style>
</head>

<body>
<div class="app">
  <div class="panel">
    <div class="header">
      <div class="left">
        <div class="title">ARTIX</div>
        <div class="subtitle">–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ¬∑ –∫–æ–¥ ¬∑ —Ñ–∞–∫—Ç—ã ¬∑ –ø–æ–≥–æ–¥–∞</div>
      </div>
      <div class="tools">
        <div class="status" id="status">–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        <button class="btn-mini" id="clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <div class="chat" id="chat"></div>

    <div class="input">
      <textarea id="input" placeholder="–ü–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–π –∫–æ–¥. Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞"></textarea>
      <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script type="module">
  import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js";

  const MODEL = "Xenova/Qwen1.5-0.5B-Chat";

  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const statusEl = document.getElementById("status");
  const sendBtn = document.getElementById("send");
  const clearBtn = document.getElementById("clear");

  function esc(s){
    return String(s).replace(/[&<>"']/g,c=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",
      '"':"&quot;","'":"&#39;"
    }[c]));
  }
  function setStatus(t){ statusEl.textContent = t; }

  function msg(text, role="bot", meta=null){
    const d=document.createElement("div");
    d.className="msg "+role;
    const b=document.createElement("div");
    b.className="bubble";
    b.innerHTML=text;
    if(meta){
      const m=document.createElement("div");
      m.className="meta";
      m.innerHTML=meta;
      b.appendChild(m);
    }
    d.appendChild(b);
    chat.appendChild(d);
    chat.scrollTop=chat.scrollHeight;
    return b;
  }

  function autoResize(){
    input.style.height="auto";
    input.style.height=Math.min(input.scrollHeight,220)+"px";
  }
  input.addEventListener("input", autoResize);
  input.addEventListener("keydown", (e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });
  sendBtn.onclick=send;

  clearBtn.onclick=()=>{
    chat.innerHTML="";
    msg("–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ü–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–π –∫–æ–¥.", "bot");
  };

  // ---------- –õ–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã ----------
  function datePlusDays(days){ const d=new Date(); d.setDate(d.getDate()+days); return d; }
  function formatDateRU(d){ return d.toLocaleDateString("ru-RU",{weekday:"long",year:"numeric",month:"long",day:"numeric"}); }

  function systemAnswer(q){
    const s=q.toLowerCase().trim();

    if(/^(–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|—Ö–∞–π|hello)\b/.test(s)) return "–ü—Ä–∏–≤–µ—Ç! üôÇ –ß–µ–º –ø–æ–º–æ—á—å?";
    if(/(–∫–∞–∫ –¥–µ–ª–∞|–∫–∞–∫ —Ç—ã)/.test(s)) return "–ù–æ—Ä–º–∞–ª—å–Ω–æ üôÇ –ß—Ç–æ –¥–µ–ª–∞–µ–º?";
    if(/(–¥–∞–≤–∞–π –ø–æ–æ–±—â–∞–µ–º—Å—è|–ø–æ–±–æ–ª—Ç–∞–µ–º)/.test(s)) return "–û–∫ üôÇ –û —á—ë–º –ø–æ–≥–æ–≤–æ—Ä–∏–º?";
    if(/(—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é)/.test(s)) return "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞!";

    if(/(–∫–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å|–∫–∞–∫–∞—è —Å–µ–≥–æ–¥–Ω—è –¥–∞—Ç–∞)/.test(s)) return formatDateRU(new Date()) + ".";
    if(/(–∫–∞–∫–æ–π –∑–∞–≤—Ç—Ä–∞ –¥–µ–Ω—å|–∫–∞–∫–∞—è –∑–∞–≤—Ç—Ä–∞ –¥–∞—Ç–∞|–∫–∞–∫–æ–µ –∑–∞–≤—Ç—Ä–∞ —á–∏—Å–ª–æ)/.test(s)) return "–ó–∞–≤—Ç—Ä–∞: " + formatDateRU(datePlusDays(1)) + ".";
    if(/(–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å|—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏|–∫–∞–∫–æ–µ –≤—Ä–µ–º—è)/.test(s)) return "–°–µ–π—á–∞—Å " + new Date().toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}) + ".";

    return null;
  }

  // ---------- –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ (—Å—Ç—Ä–æ–≥–æ number|null) ----------
  function mathTry(text){
    const clean = text.replace(/√ó/g,"*").replace(/√∑/g,"/").replace(/[^0-9+\-*/(). ]/g,"").trim();
    if(!clean) return null;
    if(!/^[0-9+\-*/(). ]+$/.test(clean)) return null;
    try{
      const r = eval(clean);
      if(typeof r==="number" && isFinite(r)) return r;
    }catch{}
    return null;
  }

  // ---------- –î–µ—Ç–µ–∫—Ç–æ—Ä –∫–æ–¥–∞ ----------
  function isCode(text){
    return /```|;|\{|\}|\bdef\b|\bclass\b|\bimport\b|System\.out|console\.log|print\(|function\b|Traceback|SyntaxError|TypeError|ReferenceError|Exception/.test(text);
  }

  // ---------- –ú–∏–Ω–∏-–±–∞–∑–∞ Python ----------
  function pythonKB(q){
    const s=q.toLowerCase();
    if ((/(—Ç–∞–π–º–µ—Ä).*(python|–ø–∞–π—Ç–æ–Ω)/.test(s) || /(python|–ø–∞–π—Ç–æ–Ω).*(—Ç–∞–π–º–µ—Ä)/.test(s))) {
      return {
        html: `
<b>–¢–∞–π–º–µ—Ä –≤ –∫–æ–Ω—Å–æ–ª–∏ (–æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç):</b>
<pre><code>import time

seconds = 10

for i in range(seconds, 0, -1):
    print(f"–û—Å—Ç–∞–ª–æ—Å—å: {i} —Å–µ–∫", end="\\r")
    time.sleep(1)

print("–ì–æ—Ç–æ–≤–æ!          ")</code></pre>`,
        meta: "–õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞: Python"
      };
    }
    if (/(–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä).*(python|–ø–∞–π—Ç–æ–Ω)/.test(s) || /(python|–ø–∞–π—Ç–æ–Ω).*(–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä)/.test(s)) {
      return {
        html: `
<b>–ü—Ä–æ—Å—Ç–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤ –∫–æ–Ω—Å–æ–ª–∏:</b>
<pre><code>def calc(expr: str) -> float:
    allowed = set("0123456789+-*/(). ")
    if any(ch not in allowed for ch in expr):
        raise ValueError("–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã")
    return eval(expr)

while True:
    expr = input("–í–≤–µ–¥–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ (–∏–ª–∏ 'exit'): ")
    if expr.lower() == "exit":
        break
    try:
        print(calc(expr))
    except Exception as e:
        print("–û—à–∏–±–∫–∞:", e)</code></pre>`,
        meta: "–õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞: Python"
      };
    }
    return null;
  }

  // ---------- –ü–æ–≥–æ–¥–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ (Open-Meteo, –±–µ–∑ –∫–ª—é—á–µ–π) ----------
  function isWeatherQuestion(q){ return /–ø–æ–≥–æ–¥–∞/.test(q.toLowerCase()); }
  function isTomorrowWeather(q){ return /–∑–∞–≤—Ç—Ä–∞/.test(q.toLowerCase()); }

  async function getCoords(){
    return await new Promise((resolve) => {
      if (!navigator.geolocation) return resolve(null);
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
        () => resolve(null),
        { enableHighAccuracy:false, timeout:5000 }
      );
    });
  }

  async function fetchWeatherByCoords(lat, lon){
    const url =
      "https://api.open-meteo.com/v1/forecast" +
      `?latitude=${encodeURIComponent(lat)}` +
      `&longitude=${encodeURIComponent(lon)}` +
      "&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max" +
      "&timezone=auto";
    const r = await fetch(url);
    if(!r.ok) return null;
    const j = await r.json();
    if(!j.daily?.time?.length) return null;
    return j;
  }

  function renderDailyWeather(j, idx, label){
    const date = j.daily.time[idx];
    const tMax = j.daily.temperature_2m_max[idx];
    const tMin = j.daily.temperature_2m_min[idx];
    const p = j.daily.precipitation_probability_max[idx];
    return `
<b>${esc(label)} (${esc(date)}):</b><br>
‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${esc(String(tMin))}‚Ä¶${esc(String(tMax))} ¬∞C<br>
‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Å–∞–¥–∫–æ–≤: ${esc(String(p ?? "‚Äî"))}%<br>
<div class="meta">–ò—Å—Ç–æ—á–Ω–∏–∫: Open-Meteo (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –∫–ª—é—á–µ–π)</div>
`.trim();
  }

  async function weatherTry(q){
    if(!isWeatherQuestion(q)) return null;
    const coords = await getCoords();
    if(!coords){
      return { html: "–ß—Ç–æ–±—ã —Å–∫–∞–∑–∞—Ç—å –ø–æ–≥–æ–¥—É, —Ä–∞–∑—Ä–µ—à–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏–ª–∏ —Å–ø—Ä–æ—Å–∏ —Ç–∞–∫: <b>‚Äú–ø–æ–≥–æ–¥–∞ –∑–∞–≤—Ç—Ä–∞ (–≤ —Ç–≤–æ—ë–º –≥–æ—Ä–æ–¥–µ)‚Äù</b>.", meta:null };
    }
    const data = await fetchWeatherByCoords(coords.lat, coords.lon);
    if(!data) return { html: "–ù–µ —Å–º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.", meta:null };
    if(isTomorrowWeather(q)) return { html: renderDailyWeather(data, 1, "–ü–æ–≥–æ–¥–∞ –Ω–∞ –∑–∞–≤—Ç—Ä–∞"), meta:null };
    return { html: renderDailyWeather(data, 0, "–ü–æ–≥–æ–¥–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è"), meta:null };
  }

  // ---------- Wikipedia: —Å–Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫ (opensearch) -> –ø–æ—Ç–æ–º summary –ø–æ title ----------
  const WIKI_STOP = new Set(["–∞–ª–æ","–∞–ª–∞","–∞–≥–∞","–æ–∫","ok","–ª–æ–ª","—Ö–∞—Ö–∞","–ø—Ä–∏–≤–µ—Ç","hi","hello","test","—Ç–µ—Å—Ç"]);
  function isWikiCandidate(q){
    const s=q.trim().toLowerCase();
    if(s.length < 4) return false;
    if(WIKI_STOP.has(s)) return false;
    if(/^[0-9+\-*/(). √ó√∑]+$/.test(s)) return false;
    if(isCode(q)) return false;
    if(isWeatherQuestion(q)) return false;
    return true;
  }

  function stripQuestionPrefix(q){
    // —á—Ç–æ–±—ã ‚Äú—á—Ç–æ —Ç–∞–∫–æ–µ raspberry pi?‚Äù –∏—Å–∫–∞–ª–æ—Å—å –∫–∞–∫ ‚Äúraspberry pi‚Äù
    return q
      .replace(/^\s*(—á—Ç–æ —Ç–∞–∫–æ–µ|–∫—Ç–æ —Ç–∞–∫–æ–π|–∫—Ç–æ —Ç–∞–∫–∞—è|–∫—Ç–æ —Ç–∞–∫–∏–µ|—á—Ç–æ –∑–Ω–∞—á–∏—Ç|–æ–±—ä—è—Å–Ω–∏(,)? —á—Ç–æ —Ç–∞–∫–æ–µ)\s+/i, "")
      .replace(/\?+$/,"")
      .trim();
  }

  async function wikiSearchTitle(q){
    const query = stripQuestionPrefix(q);
    const url = "https://ru.wikipedia.org/w/api.php" +
      "?action=opensearch&limit=1&namespace=0&format=json&origin=*" +
      "&search=" + encodeURIComponent(query);

    const r = await fetch(url);
    if(!r.ok) return null;
    const j = await r.json(); // [search, [titles], [descriptions], [links]]
    const title = j?.[1]?.[0];
    const link  = j?.[3]?.[0];
    if(!title) return null;
    return { title, link };
  }

  async function wikiSummaryByTitle(title){
    const url = "https://ru.wikipedia.org/api/rest_v1/page/summary/" + encodeURIComponent(title);
    const r = await fetch(url);
    if(!r.ok) return null;
    const j = await r.json();
    if(!j.extract) return null;
    return j;
  }

  async function wikiTry(q){
    if(!isWikiCandidate(q)) return null;

    try{
      const found = await wikiSearchTitle(q);
      if(!found) return null;

      const sum = await wikiSummaryByTitle(found.title);
      if(!sum) return null;

      const text = sum.extract.split(/(?<=\.)\s+/).slice(0,4).join(" ");
      const link = sum.content_urls?.desktop?.page || found.link;

      return {
        html: esc(text),
        meta: link ? `–ò—Å—Ç–æ—á–Ω–∏–∫: <a href="${link}" target="_blank" rel="noopener noreferrer">Wikipedia</a>` : "–ò—Å—Ç–æ—á–Ω–∏–∫: Wikipedia"
      };
    }catch{
      return null;
    }
  }

  // ---------- LLM ----------
  let generator = null;

  setStatus("–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏‚Ä¶");
  msg("–ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å‚Ä¶ –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ª–≥–∏–º (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ –∫—ç—à).", "bot");

  try{
    generator = await pipeline("text-generation", MODEL);
    setStatus("–≥–æ—Ç–æ–≤");
    msg("–ì–æ—Ç–æ–≤–æ. –ü–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–π –∫–æ–¥.", "bot", `–ú–æ–¥–µ–ª—å: <b>${esc(MODEL)}</b>`);
  }catch(e){
    setStatus("–æ—à–∏–±–∫–∞ –º–æ–¥–µ–ª–∏");
    msg(`<b>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å</b><pre><code>${esc(String(e))}</code></pre>`, "bot");
  }

  function buildPrompt(userText){
    if(isCode(userText)){
      return [
        "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.",
        "–í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ä–µ—à–µ–Ω–∏–µ. –§–æ—Ä–º–∞—Ç:",
        "```<–∫–æ–¥>```",
        "–ü–æ—è—Å–Ω–µ–Ω–∏–µ 1-5 –ø—É–Ω–∫—Ç–æ–≤.",
        "",
        userText,
        "",
        "–û—Ç–≤–µ—Ç:"
      ].join("\n");
    }
    return [
      "–¢—ã —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.",
      "–û—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏. –ö—Ä–∞—Ç–∫–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ–±—â–∏–π ‚Äî –¥–∞–π –ø—Ä–∏–º–µ—Ä.",
      "",
      userText,
      "",
      "–û—Ç–≤–µ—Ç:"
    ].join("\n");
  }

  function renderLLM(text){
    const safe = esc(text || "").trim();
    if(!safe) return null;
    return safe.replace(/```([\s\S]*?)```/g, (m,g1)=>`<pre><code>${g1}</code></pre>`);
  }

  function looksUselessAnswer(ans){
    const s = (ans||"").toLowerCase();
    // –µ—Å–ª–∏ –º–æ–¥–µ–ª—å —Ä–µ–∞–ª—å–Ω–æ ‚Äú—Å–¥–∞–ª–∞—Å—å‚Äù ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º wiki
    return (
      s.includes("–Ω–µ –∑–Ω–∞—é") ||
      s.includes("–Ω–µ —É–≤–µ—Ä–µ–Ω") ||
      s.includes("–Ω–µ –º–æ–≥—É") ||
      s.includes("–Ω–µ —Å–º–æ–≥") ||
      s.length < 20
    );
  }

  // ---------- send() ----------
  async function send(){
    const text=input.value.trim();
    if(!text) return;

    input.value=""; autoResize();
    msg(esc(text), "user");

    // 1) –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞
    const m = mathTry(text);
    if(m !== null){ msg("–û—Ç–≤–µ—Ç: " + esc(String(m)), "bot"); return; }

    // 2) —Å–∏—Å—Ç–µ–º–Ω—ã–µ
    const sys = systemAnswer(text);
    if(sys){ msg(esc(sys), "bot"); return; }

    // 3) –ø–æ–≥–æ–¥–∞
    const weather = await weatherTry(text);
    if(weather){ msg(weather.html, "bot", weather.meta); return; }

    // 4) python kb
    const py = pythonKB(text);
    if(py){ msg(py.html, "bot", py.meta); return; }

    // 5) LLM
    let llmRendered = null;
    let llmRaw = null;

    if(generator){
      setStatus("–¥—É–º–∞—é‚Ä¶");
      const thinking = msg("–î—É–º–∞—é‚Ä¶", "bot");
      try{
        const prompt = buildPrompt(text);
        const out = await generator(prompt,{
          max_new_tokens: 520,
          temperature: 0.6,
          top_p: 0.9,
          do_sample: true,
          return_full_text: false
        });
        llmRaw = out?.[0]?.generated_text ?? "";
        llmRendered = renderLLM(llmRaw);
      }catch(e){
        llmRendered = `–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: <pre><code>${esc(String(e))}</code></pre>`;
      }finally{
        thinking.parentElement.remove();
        setStatus("–≥–æ—Ç–æ–≤");
      }
    }

    // –ï—Å–ª–∏ LLM –¥–∞–ª –Ω–æ—Ä–º –æ—Ç–≤–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    if(llmRendered && !looksUselessAnswer(llmRaw)){
      msg(llmRendered, "bot");
      return;
    }

    // 6) Wikipedia (–ø–æ–∏—Å–∫+summary) ‚Äî —Å–∏–ª—å–Ω—ã–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fallback
    const wiki = await wikiTry(text);
    if(wiki){
      // –ï—Å–ª–∏ LLM –±—ã–ª —Å–ª–∞–±—ã–π ‚Äî –ø–æ–∫–∞–∂–µ–º –∫–æ—Ä–æ—Ç–∫–æ, –Ω–æ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º
      msg(wiki.html, "bot", wiki.meta);
      return;
    }

    // 7) –ï—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–∏—á–µ–≥–æ ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∂–µ–º LLM —á—Ç–æ –±—ã–ª–æ (—á—Ç–æ–±—ã –Ω–µ ‚Äú–º–æ–ª—á–∞–ª‚Äù)
    if(llmRendered){
      msg(llmRendered, "bot");
      return;
    }

    msg("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç (–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞/–∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã). –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.", "bot");
  }
</script>
</body>
</html>
