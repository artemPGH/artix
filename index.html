<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ARTIX</title>

<style>
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:radial-gradient(circle at top,#0b1220,#020308 70%);color:#e5e7eb}
  .app{height:100%;display:flex;padding:14px}
  .panel{flex:1;background:rgba(8,10,26,.96);border-radius:18px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 0 40px rgba(0,0,0,.8)}
  .header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center;gap:12px}
  .left{min-width:0}
  .title{letter-spacing:.18em;font-weight:800;text-transform:uppercase}
  .subtitle{font-size:12px;opacity:.6;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70vw}
  .status{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);opacity:.9;white-space:nowrap}
  .chat{flex:1;padding:16px;overflow-y:auto;background:rgba(15,23,42,.92)}
  .msg{margin-bottom:10px;display:flex}
  .msg.user{justify-content:flex-end}
  .msg.bot{justify-content:flex-start}
  .bubble{max-width:90%;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.08);white-space:pre-wrap;word-break:break-word}
  .user .bubble{background:linear-gradient(135deg,#2563eb55,#020617)}
  .bot .bubble{background:linear-gradient(135deg,#10b98133,#020617)}
  .meta{margin-top:8px;font-size:11px;opacity:.6}
  pre{background:#020617;border:1px solid rgba(148,163,184,.35);padding:12px;border-radius:12px;overflow-x:auto;margin:10px 0 0}
  code{font-family:ui-monospace,Consolas,monospace;font-size:13px}
  .input{padding:12px;border-top:1px solid rgba(255,255,255,.06);display:flex;gap:10px;align-items:flex-end}
  textarea{flex:1;min-height:48px;max-height:220px;resize:none;background:#020617;color:#e5e7eb;border:1px solid rgba(148,163,184,.4);border-radius:12px;padding:10px;outline:none;line-height:1.35}
  button{background:linear-gradient(135deg,#4f46e5,#06b6d4);border:none;color:#fff;font-weight:800;border-radius:12px;padding:10px 16px;cursor:pointer;white-space:nowrap}
  button:hover{opacity:.92}
  .tools{display:flex;gap:8px;align-items:center}
  .btn-mini{background:rgba(2,6,23,.25);border:1px solid rgba(148,163,184,.25);padding:7px 10px;border-radius:999px;font-weight:700}
  .btn-mini:hover{border-color:rgba(148,163,184,.55)}
</style>
</head>

<body>
<div class="app">
  <div class="panel">
    <div class="header">
      <div class="left">
        <div class="title">ARTIX</div>
        <div class="subtitle">—É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ¬∑ –∫–æ–¥ ¬∑ —Ñ–∞–∫—Ç—ã</div>
      </div>
      <div class="tools">
        <div class="status" id="status">–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        <button class="btn-mini" id="clear">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
      </div>
    </div>

    <div class="chat" id="chat"></div>

    <div class="input">
      <textarea id="input" placeholder="–ü–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–π –∫–æ–¥. Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞"></textarea>
      <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script type="module">
  import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js";

  // Chat-–º–æ–¥–µ–ª—å (–Ω–µ codegen). –†–∞–±–æ—Ç–∞–µ—Ç –∑–∞–º–µ—Ç–Ω–æ –ª—É—á—à–µ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞.
  const MODEL = "Xenova/Qwen1.5-0.5B-Chat";

  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const statusEl = document.getElementById("status");
  const sendBtn = document.getElementById("send");
  const clearBtn = document.getElementById("clear");

  function esc(s){
    return String(s).replace(/[&<>"']/g,c=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",
      '"':"&quot;","'":"&#39;"
    }[c]));
  }

  function setStatus(t){ statusEl.textContent = t; }

  function msg(text, role="bot", meta=null){
    const d=document.createElement("div");
    d.className="msg "+role;
    const b=document.createElement("div");
    b.className="bubble";
    b.innerHTML=text;

    if(meta){
      const m=document.createElement("div");
      m.className="meta";
      m.innerHTML=meta;
      b.appendChild(m);
    }

    d.appendChild(b);
    chat.appendChild(d);
    chat.scrollTop=chat.scrollHeight;
    return b;
  }

  function autoResize(){
    input.style.height="auto";
    input.style.height=Math.min(input.scrollHeight,220)+"px";
  }
  input.addEventListener("input", autoResize);

  input.addEventListener("keydown", (e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });
  sendBtn.onclick=send;

  clearBtn.onclick=()=>{
    chat.innerHTML="";
    msg("–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ü–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–π –∫–æ–¥.", "bot");
  };

  // ---------------- 1) –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã ----------------
  function systemAnswer(q){
    const s=q.toLowerCase().trim();

    if(/^(–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|—Ö–∞–π|hello)\b/.test(s))
      return "–ü—Ä–∏–≤–µ—Ç! –ü–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–π –∫–æ–¥ ‚Äî –ø–æ–º–æ–≥—É.";

    if(/(–∫–∞–∫ –¥–µ–ª–∞|–∫–∞–∫ —Ç—ã)/.test(s))
      return "–ù–æ—Ä–º–∞–ª—å–Ω–æ üôÇ –ö–∏–¥–∞–π –∑–∞–¥–∞—á—É –∏–ª–∏ –∫–æ–¥ ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º.";

    if(/(—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é)/.test(s))
      return "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞!";

    if(/(–∫–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å|–∫–∞–∫–∞—è —Å–µ–≥–æ–¥–Ω—è –¥–∞—Ç–∞)/.test(s)){
      return new Date().toLocaleDateString("ru-RU",{weekday:"long",year:"numeric",month:"long",day:"numeric"}) + ".";
    }

    if(/(–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å|—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏|–∫–∞–∫–æ–µ –≤—Ä–µ–º—è)/.test(s)){
      return "–°–µ–π—á–∞—Å " + new Date().toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}) + ".";
    }

    return null;
  }

  // ---------------- 2) –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ (—Ñ–∏–∫—Å undefined) ----------------
  function mathTry(text){
    // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Ç–µ–º. —Å–∏–º–≤–æ–ª—ã
    const clean = text
      .replace(/√ó/g,"*")
      .replace(/√∑/g,"/")
      .replace(/[^0-9+\-*/(). ]/g,"")
      .trim();

    if(!clean) return null;

    // –∑–∞—â–∏—Ç–∞: —Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
    if(!/^[0-9+\-*/(). ]+$/.test(clean)) return null;

    try{
      const result = eval(clean);
      if(typeof result === "number" && isFinite(result)) return result;
    }catch{}

    return null;
  }

  // ---------------- 3) –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ "–∫–æ–¥/–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ" ----------------
  function isCode(text){
    const t=text;
    return (
      /```/.test(t) ||
      /;|\{|\}|\bdef\b|\bclass\b|\bimport\b|System\.out|console\.log|print\(|function\b/.test(t) ||
      /Traceback|SyntaxError|TypeError|ReferenceError|Exception/.test(t)
    );
  }

  // ---------------- 4) Wikipedia fallback (—á—Ç–æ–±—ã –Ω–µ –æ—Ç–≤–µ—á–∞—Ç—å –º—É—Å–æ—Ä–æ–º) ----------------
  const WIKI_STOP = new Set(["–∞–ª–æ","–∞–ª–∞","–∞–≥–∞","–æ–∫","ok","–ª–æ–ª","—Ö–∞—Ö–∞","–ø—Ä–∏–≤–µ—Ç","hi","hello","test","—Ç–µ—Å—Ç"]);
  function isWikiCandidate(q){
    const s=q.trim().toLowerCase();
    if(s.length < 4) return false;
    if(WIKI_STOP.has(s)) return false;
    // –µ—Å–ª–∏ —ç—Ç–æ —è–≤–Ω–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏–ª–∏ –∫—É—Å–æ–∫ –∫–æ–¥–∞ ‚Äî –≤ –≤–∏–∫–∏ –Ω–µ –ª–µ–∑–µ–º
    if(/^[0-9+\-*/(). √ó√∑]+$/.test(s)) return false;
    if(isCode(q)) return false;
    return true;
  }

  async function wikiTry(q){
    if(!isWikiCandidate(q)) return null;

    try{
      const url="https://ru.wikipedia.org/api/rest_v1/page/summary/"+encodeURIComponent(q);
      const r=await fetch(url);
      if(!r.ok) return null;
      const j=await r.json();
      if(!j.extract) return null;

      const text = j.extract.split(/(?<=\.)\s+/).slice(0,4).join(" ");
      const link = j.content_urls?.desktop?.page;

      return {
        html: esc(text),
        meta: link ? `–ò—Å—Ç–æ—á–Ω–∏–∫: <a href="${link}" target="_blank" rel="noopener noreferrer">Wikipedia</a>` : "–ò—Å—Ç–æ—á–Ω–∏–∫: Wikipedia"
      };
    }catch{
      return null;
    }
  }

  // ---------------- 5) LLM (–æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç) ----------------
  let generator;
  setStatus("–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏‚Ä¶");
  msg("–ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å‚Ä¶ –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ª–≥–∏–º (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ –∫—ç—à).", "bot");

  try{
    generator = await pipeline("text-generation", MODEL);
    setStatus("–≥–æ—Ç–æ–≤");
    msg("–ì–æ—Ç–æ–≤–æ. –ü–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–π –∫–æ–¥.", "bot", `–ú–æ–¥–µ–ª—å: <b>${esc(MODEL)}</b>`);
  }catch(e){
    setStatus("–æ—à–∏–±–∫–∞ –º–æ–¥–µ–ª–∏");
    msg(`<b>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å</b>\n\n<pre><code>${esc(String(e))}</code></pre>\n\n–ü–æ–ø—Ä–æ–±—É–π –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –≤ Chrome/Edge –∏ –æ–±–Ω–æ–≤–∏—Ç—å Ctrl+F5.`, "bot");
  }

  function buildPrompt(userText){
    // –∂—ë—Å—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
    if(isCode(userText)){
      return [
        "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.",
        "–ó–∞–¥–∞—á–∞: –∏—Å–ø—Ä–∞–≤–∏—Ç—å/–Ω–∞–ø–∏—Å–∞—Ç—å/–æ–±—ä—è—Å–Ω–∏—Ç—å –∫–æ–¥.",
        "–ü—Ä–∞–≤–∏–ª–∞:",
        "- –°–Ω–∞—á–∞–ª–∞: –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–∫–æ–¥) –≤ ``` ```",
        "- –ü–æ—Ç–æ–º: –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (1-5 –ø—É–Ω–∫—Ç–æ–≤)",
        "- –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî –∑–∞–¥–∞–π 1 —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å",
        "",
        "–ó–∞–ø—Ä–æ—Å:",
        userText,
        "",
        "–û—Ç–≤–µ—Ç:"
      ].join("\n");
    }

    return [
      "–¢—ã —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.",
      "–û—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ.",
      "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ —Ñ–∞–∫—Ç ‚Äî –¥–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π —Ñ–∞–∫—Ç.",
      "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ–ø–æ–ª–Ω—ã–π ‚Äî –ø–æ–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å.",
      "",
      "–í–æ–ø—Ä–æ—Å:",
      userText,
      "",
      "–û—Ç–≤–µ—Ç:"
    ].join("\n");
  }

  function renderLLM(text){
    const safe = esc(text || "").trim();

    if(!safe) return null;

    // —Ä–µ–Ω–¥–µ—Ä ```code```
    const withCode = safe.replace(/```([\s\S]*?)```/g, (m,g1)=>`<pre><code>${g1}</code></pre>`);

    return withCode;
  }

  // ---------------- send() (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∫–∞–∫ —É ‚Äú—É–º–Ω–æ–≥–æ‚Äù –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞) ----------------
  async function send(){
    const text=input.value.trim();
    if(!text) return;

    input.value=""; autoResize();
    msg(esc(text), "user");

    // 1) –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞
    const m = mathTry(text);
    if(m !== null){
      msg("–û—Ç–≤–µ—Ç: " + esc(String(m)), "bot");
      return;
    }

    // 2) —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    const sys = systemAnswer(text);
    if(sys){
      msg(esc(sys), "bot");
      return;
    }

    // 3) LLM (–≥–ª–∞–≤–Ω—ã–π)
    if(generator){
      setStatus("–¥—É–º–∞—é‚Ä¶");
      const thinking = msg("–î—É–º–∞—é‚Ä¶", "bot");

      try{
        const prompt = buildPrompt(text);

        const out = await generator(prompt,{
          max_new_tokens: 500,
          temperature: 0.55,
          top_p: 0.9,
          do_sample: true,
          return_full_text: false
        });

        const gen = out?.[0]?.generated_text ?? "";
        const rendered = renderLLM(gen);

        thinking.parentElement.remove(); // —É–±–∏—Ä–∞–µ–º "–î—É–º–∞—é‚Ä¶"

        if(rendered){
          msg(rendered, "bot");
          setStatus("–≥–æ—Ç–æ–≤");
          return;
        }
      }catch(e){
        thinking.parentElement.remove();
        msg(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: <pre><code>${esc(String(e))}</code></pre>`, "bot");
      }finally{
        setStatus("–≥–æ—Ç–æ–≤");
      }
    }

    // 4) Wikipedia fallback (–µ—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∞)
    const wiki = await wikiTry(text);
    if(wiki){
      msg(wiki.html, "bot", wiki.meta);
      return;
    }

    msg("–Ø –Ω–µ —Å–º–æ–≥ –æ—Ç–≤–µ—Ç–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π —É—Ç–æ—á–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç.", "bot");
  }
</script>
</body>
</html>
