<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ARTIX</title>

<style>
*{box-sizing:border-box}
html,body{
  margin:0;height:100%;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:radial-gradient(circle at top,#0b1220,#020308 70%);
  color:#e5e7eb;
}
.app{
  height:100%;
  display:flex;
  flex-direction:column;
  padding:14px;
}
.panel{
  flex:1;
  background:rgba(8,10,26,.96);
  border-radius:18px;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  box-shadow:0 0 40px rgba(0,0,0,.8);
}
.header{
  padding:14px 18px;
  border-bottom:1px solid rgba(255,255,255,.06);
  display:flex;
  justify-content:space-between;
}
.title{letter-spacing:.18em;font-weight:700}
.subtitle{font-size:12px;opacity:.6}
.status{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.35);
}
.chat{
  flex:1;
  padding:16px;
  overflow-y:auto;
  background:rgba(15,23,42,.92);
}
.msg{margin-bottom:10px;display:flex}
.msg.user{justify-content:flex-end}
.msg.bot{justify-content:flex-start}
.bubble{
  max-width:90%;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
  white-space:pre-wrap;
}
.user .bubble{background:linear-gradient(135deg,#2563eb55,#020617)}
.bot .bubble{background:linear-gradient(135deg,#10b98133,#020617)}
pre{
  background:#020617;
  border:1px solid rgba(148,163,184,.4);
  padding:12px;
  border-radius:12px;
  overflow-x:auto;
}
code{font-family:ui-monospace,Consolas,monospace;font-size:13px}
.input{
  padding:12px;
  border-top:1px solid rgba(255,255,255,.06);
  display:flex;
  gap:10px;
}
textarea{
  flex:1;
  min-height:48px;
  max-height:220px;
  resize:none;
  background:#020617;
  color:#e5e7eb;
  border:1px solid rgba(148,163,184,.4);
  border-radius:12px;
  padding:10px;
}
button{
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  border:none;
  color:#fff;
  font-weight:700;
  border-radius:12px;
  padding:10px 16px;
  cursor:pointer;
}
button:hover{opacity:.9}
</style>
</head>

<body>
<div class="app">
  <div class="panel">
    <div class="header">
      <div>
        <div class="title">ARTIX</div>
        <div class="subtitle">умный ассистент · код · факты</div>
      </div>
      <div class="status" id="status">загрузка…</div>
    </div>

    <div class="chat" id="chat"></div>

    <div class="input">
      <textarea id="input" placeholder="Пиши вопрос или вставляй код. Enter — отправить, Shift+Enter — новая строка"></textarea>
      <button id="send">Отправить</button>
    </div>
  </div>
</div>

<script type="module">
import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js";

const MODEL = "Xenova/Qwen1.5-0.5B-Chat";

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const statusEl = document.getElementById("status");
const sendBtn = document.getElementById("send");

function msg(text, role){
  const d=document.createElement("div");
  d.className="msg "+role;
  const b=document.createElement("div");
  b.className="bubble";
  b.innerHTML=text;
  d.appendChild(b);
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

function esc(s){
  return s.replace(/[&<>"']/g,c=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",
    '"':"&quot;","'":"&#39;"
  }[c]));
}

function auto(){
  input.style.height="auto";
  input.style.height=Math.min(input.scrollHeight,220)+"px";
}
input.addEventListener("input",auto);

function mathTry(t){
  const c=t.replace(/×/g,"*").replace(/÷/g,"/").replace(/[^0-9+\-*/(). ]/g,"");
  if(!c)return null;
  try{return eval(c)}catch{return null}
}

async function wikiTry(q){
  try{
    const r=await fetch("https://ru.wikipedia.org/api/rest_v1/page/summary/"+encodeURIComponent(q));
    if(!r.ok)return null;
    const j=await r.json();
    if(j.extract)return j.extract+"<div style='opacity:.6;font-size:11px'>Источник: Wikipedia</div>";
  }catch{}
  return null;
}

function isCode(t){
  return /(;|\{|\}|\bdef\b|\bclass\b|System\.out|print\(|function)/.test(t);
}

let generator;
statusEl.textContent="загрузка модели…";
generator = await pipeline("text-generation", MODEL);
statusEl.textContent="готов";

msg("Привет! Я ARTIX. Пиши вопрос или вставляй код.", "bot");

async function send(){
  const text=input.value.trim();
  if(!text)return;
  input.value="";auto();
  msg(esc(text),"user");

  const m=mathTry(text);
  if(m!==null){msg("Ответ: "+m,"bot");return;}

  const w=await wikiTry(text);
  if(w){msg(w,"bot");return;}

  statusEl.textContent="думаю…";

  const prompt = isCode(text)
? `Ты программист. Исправь или напиши код. Сначала код, потом краткое объяснение.\n\n${text}\n\nОтвет:`
: `Ты умный ассистент. Ответь кратко и понятно.\n\nВопрос: ${text}\n\nОтвет:`;

  const out = await generator(prompt,{
    max_new_tokens:400,
    temperature:0.6,
    top_p:0.9,
    do_sample:true,
    return_full_text:false
  });

  let r = esc(out[0].generated_text || "");
  r = r.replace(/```([\s\S]*?)```/g,"<pre><code>$1</code></pre>");
  msg(r || "Не смог ответить. Попробуй уточнить.","bot");
  statusEl.textContent="готов";
}

sendBtn.onclick=send;
input.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send()}
});
</script>
</body>
</html>
