<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ARTIX</title>

<style>
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:radial-gradient(circle at top,#0b1220,#020308 70%);color:#e5e7eb}
  .app{height:100%;display:flex;padding:14px}
  .panel{flex:1;background:rgba(8,10,26,.96);border-radius:18px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 0 40px rgba(0,0,0,.8)}
  .header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center;gap:12px}
  .left{min-width:0}
  .title{letter-spacing:.18em;font-weight:900;text-transform:uppercase}
  .subtitle{font-size:12px;opacity:.6;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70vw}
  .status{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);opacity:.9;white-space:nowrap}
  .chat{flex:1;padding:16px;overflow-y:auto;background:rgba(15,23,42,.92)}
  .msg{margin-bottom:10px;display:flex}
  .msg.user{justify-content:flex-end}
  .msg.bot{justify-content:flex-start}
  .bubble{max-width:90%;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.08);white-space:pre-wrap;word-break:break-word}
  .user .bubble{background:linear-gradient(135deg,#2563eb55,#020617)}
  .bot .bubble{background:linear-gradient(135deg,#10b98133,#020617)}
  .meta{margin-top:8px;font-size:11px;opacity:.65}
  pre{background:#020617;border:1px solid rgba(148,163,184,.35);padding:12px;border-radius:12px;overflow-x:auto;margin:10px 0 0}
  code{font-family:ui-monospace,Consolas,monospace;font-size:13px}
  .input{padding:12px;border-top:1px solid rgba(255,255,255,.06);display:flex;gap:10px;align-items:flex-end}
  textarea{flex:1;min-height:48px;max-height:220px;resize:none;background:#020617;color:#e5e7eb;border:1px solid rgba(148,163,184,.4);border-radius:12px;padding:10px;outline:none;line-height:1.35}
  button{background:linear-gradient(135deg,#4f46e5,#06b6d4);border:none;color:#fff;font-weight:900;border-radius:12px;padding:10px 16px;cursor:pointer;white-space:nowrap}
  button:hover{opacity:.92}
  .tools{display:flex;gap:8px;align-items:center}
  .btn-mini{background:rgba(2,6,23,.25);border:1px solid rgba(148,163,184,.25);padding:7px 10px;border-radius:999px;font-weight:800}
  .btn-mini:hover{border-color:rgba(148,163,184,.55)}
</style>
</head>

<body>
<div class="app">
  <div class="panel">
    <div class="header">
      <div class="left">
        <div class="title">ARTIX</div>
        <div class="subtitle">—É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ¬∑ –∫–æ–¥ ¬∑ —Ñ–∞–∫—Ç—ã ¬∑ –ø–æ–≥–æ–¥–∞</div>
      </div>
      <div class="tools">
        <div class="status" id="status">–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        <button class="btn-mini" id="clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <div class="chat" id="chat"></div>

    <div class="input">
      <textarea id="input" placeholder="–ü–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–π –∫–æ–¥. Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞"></textarea>
      <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script type="module">
  import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js";

  // –ú–∞–ª–µ–Ω—å–∫–∞—è chat-–º–æ–¥–µ–ª—å. –í –±—Ä–∞—É–∑–µ—Ä–µ —ç—Ç–æ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å.
  // –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å ‚Äî –¥–∞–º —Å–ø–∏—Å–æ–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤ –ø–æ–¥ —Ç–≤–æ—ë –∂–µ–ª–µ–∑–æ.
  const MODEL = "Xenova/Qwen1.5-0.5B-Chat";

  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const statusEl = document.getElementById("status");
  const sendBtn = document.getElementById("send");
  const clearBtn = document.getElementById("clear");

  function esc(s){
    return String(s).replace(/[&<>"']/g,c=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",
      '"':"&quot;","'":"&#39;"
    }[c]));
  }
  function setStatus(t){ statusEl.textContent = t; }

  function msg(text, role="bot", meta=null){
    const d=document.createElement("div");
    d.className="msg "+role;
    const b=document.createElement("div");
    b.className="bubble";
    b.innerHTML=text;

    if(meta){
      const m=document.createElement("div");
      m.className="meta";
      m.innerHTML=meta;
      b.appendChild(m);
    }

    d.appendChild(b);
    chat.appendChild(d);
    chat.scrollTop=chat.scrollHeight;
    return b;
  }

  function autoResize(){
    input.style.height="auto";
    input.style.height=Math.min(input.scrollHeight,220)+"px";
  }
  input.addEventListener("input", autoResize);

  input.addEventListener("keydown", (e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });
  sendBtn.onclick=send;

  clearBtn.onclick=()=>{
    chat.innerHTML="";
    msg("–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ü–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–π –∫–æ–¥.", "bot");
  };

  // ---------------- 1) –õ–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (—á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –ò–ò) ----------------
  function isTomorrowQuestion(s){
    return /(–∫–∞–∫–æ–π –∑–∞–≤—Ç—Ä–∞ –¥–µ–Ω—å|–∫–∞–∫–∞—è –∑–∞–≤—Ç—Ä–∞ –¥–∞—Ç–∞|–∫–∞–∫–æ–µ –∑–∞–≤—Ç—Ä–∞ —á–∏—Å–ª–æ)/.test(s);
  }

  function datePlusDays(days){
    const d = new Date();
    d.setDate(d.getDate() + days);
    return d;
  }

  function formatDateRU(d){
    return d.toLocaleDateString("ru-RU",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
  }

  function systemAnswer(q){
    const s=q.toLowerCase().trim();

    if(/^(–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|—Ö–∞–π|hello)\b/.test(s))
      return "–ü—Ä–∏–≤–µ—Ç! –ü–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–π –∫–æ–¥ ‚Äî –ø–æ–º–æ–≥—É.";

    if(/(–∫–∞–∫ –¥–µ–ª–∞|–∫–∞–∫ —Ç—ã)/.test(s))
      return "–ù–æ—Ä–º–∞–ª—å–Ω–æ üôÇ –ö–∏–¥–∞–π –∑–∞–¥–∞—á—É –∏–ª–∏ –∫–æ–¥ ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º.";

    if(/(—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é)/.test(s))
      return "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞!";

    if(/(–∫–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å|–∫–∞–∫–∞—è —Å–µ–≥–æ–¥–Ω—è –¥–∞—Ç–∞)/.test(s)){
      return formatDateRU(new Date()) + ".";
    }

    if(isTomorrowQuestion(s)){
      return "–ó–∞–≤—Ç—Ä–∞: " + formatDateRU(datePlusDays(1)) + ".";
    }

    if(/(–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å|—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏|–∫–∞–∫–æ–µ –≤—Ä–µ–º—è)/.test(s)){
      return "–°–µ–π—á–∞—Å " + new Date().toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}) + ".";
    }

    return null;
  }

  // ---------------- 2) –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ (–±–µ–∑ undefined) ----------------
  function mathTry(text){
    const clean = text
      .replace(/√ó/g,"*")
      .replace(/√∑/g,"/")
      .replace(/[^0-9+\-*/(). ]/g,"")
      .trim();

    if(!clean) return null;
    if(!/^[0-9+\-*/(). ]+$/.test(clean)) return null;

    try{
      const result = eval(clean);
      if(typeof result === "number" && isFinite(result)) return result;
    }catch{}
    return null;
  }

  // ---------------- 3) –î–µ—Ç–µ–∫—Ç–æ—Ä –∫–æ–¥–∞ ----------------
  function isCode(text){
    const t=text;
    return (
      /```/.test(t) ||
      /;|\{|\}|\bdef\b|\bclass\b|\bimport\b|System\.out|console\.log|print\(|function\b/.test(t) ||
      /Traceback|SyntaxError|TypeError|ReferenceError|Exception/.test(t)
    );
  }

  // ---------------- 4) –ú–∏–Ω–∏-–±–∞–∑–∞ –ø–æ Python (—á—Ç–æ–±—ã ‚Äú–ø–∏—Å–∞–ª –∫–æ–¥‚Äù —Å—Ç–∞–±–∏–ª—å–Ω–æ) ----------------
  function pythonKB(q){
    const s=q.toLowerCase();

    // —Ç–∞–π–º–µ—Ä –≤ –∫–æ–Ω—Å–æ–ª–∏
    if (/(—Ç–∞–π–º–µ—Ä).*(python|–ø–∞–π—Ç–æ–Ω)/.test(s) || /(python|–ø–∞–π—Ç–æ–Ω).*(—Ç–∞–π–º–µ—Ä)/.test(s)) {
      return {
        html: `
<b>–¢–∞–π–º–µ—Ä –≤ –∫–æ–Ω—Å–æ–ª–∏ (–æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç):</b>
<pre><code>import time

seconds = 10  # —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –∂–¥–∞—Ç—å

for i in range(seconds, 0, -1):
    print(f"–û—Å—Ç–∞–ª–æ—Å—å: {i} —Å–µ–∫", end="\\r")
    time.sleep(1)

print("–ì–æ—Ç–æ–≤–æ!          ")</code></pre>

<b>–¢–∞–π–º–µ—Ä + –≤–≤–æ–¥ –º–∏–Ω—É—Ç/—Å–µ–∫—É–Ω–¥:</b>
<pre><code>import time

minutes = int(input("–ú–∏–Ω—É—Ç: "))
seconds = int(input("–°–µ–∫—É–Ω–¥: "))
total = minutes * 60 + seconds

for left in range(total, 0, -1):
    m, s = divmod(left, 60)
    print(f"{m:02d}:{s:02d}", end="\\r")
    time.sleep(1)

print("00:00\\n–ì–æ—Ç–æ–≤–æ!")</code></pre>
`,
        meta: "–õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞: Python"
      };
    }

    // —á—Ç–æ –¥–µ–ª–∞–µ—Ç len
    if (/(—á—Ç–æ –¥–µ–ª–∞–µ—Ç|–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç).*\blen\b/.test(s) || /\blen\(\)\b/.test(s)) {
      return {
        html: `
<b>len(x)</b> –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–ª–∏–Ω—É –æ–±—ä–µ–∫—Ç–∞:
<pre><code>len("abc")      # 3
len([1,2,3,4])  # 4
len({"a": 1})   # 1</code></pre>
–†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —Å—Ç—Ä–æ–∫, —Å–ø–∏—Å–∫–æ–≤, —Å–ª–æ–≤–∞—Ä–µ–π, –º–Ω–æ–∂–µ—Å—Ç–≤ –∏ —Ç.–¥.`,
        meta: "–õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞: Python"
      };
    }

    // —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª
    if (/—Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª/.test(s)) {
      return {
        html: `
<b>–§–∞–∫—Ç–æ—Ä–∏–∞–ª (n!)</b>
<pre><code>def factorial(n: int) -> int:
    if n &lt; 0:
        raise ValueError("n –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å &gt;= 0")
    result = 1
    for i in range(2, n + 1):
        result *= i
    return result

print(factorial(5))  # 120</code></pre>`,
        meta: "–õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞: Python"
      };
    }

    return null;
  }

  // ---------------- 5) –ü–æ–≥–æ–¥–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ (Open-Meteo, –±–µ–∑ –∫–ª—é—á–µ–π) ----------------
  function isWeatherQuestion(q){
    const s=q.toLowerCase();
    return /–ø–æ–≥–æ–¥–∞/.test(s);
  }
  function isTomorrowWeather(q){
    const s=q.toLowerCase();
    return /–∑–∞–≤—Ç—Ä–∞/.test(s);
  }

  async function getCoords(){
    // –ø–æ–ø—Ä–æ–±—É–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –±—Ä–∞—É–∑–µ—Ä–∞
    return await new Promise((resolve) => {
      if (!navigator.geolocation) return resolve(null);
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
        () => resolve(null),
        { enableHighAccuracy: false, timeout: 5000 }
      );
    });
  }

  async function fetchWeatherByCoords(lat, lon){
    // Daily forecast: max/min + precipitation probability
    const url =
      "https://api.open-meteo.com/v1/forecast" +
      `?latitude=${encodeURIComponent(lat)}` +
      `&longitude=${encodeURIComponent(lon)}` +
      "&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max" +
      "&timezone=auto";

    const r = await fetch(url);
    if(!r.ok) return null;
    const j = await r.json();
    if(!j.daily || !j.daily.time) return null;
    return j;
  }

  function renderTomorrowWeather(j){
    const idx = 1; // –∑–∞–≤—Ç—Ä–∞
    const date = j.daily.time[idx];
    const tMax = j.daily.temperature_2m_max[idx];
    const tMin = j.daily.temperature_2m_min[idx];
    const p = j.daily.precipitation_probability_max[idx];

    return `
<b>–ü–æ–≥–æ–¥–∞ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ (${esc(date)}):</b>
‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${esc(String(tMin))}‚Ä¶${esc(String(tMax))} ¬∞C<br>
‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Å–∞–¥–∫–æ–≤: ${esc(String(p ?? "‚Äî"))}%<br>
<div class="meta">–ò—Å—Ç–æ—á–Ω–∏–∫: Open-Meteo (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –∫–ª—é—á–µ–π)</div>
`.trim();
  }

  async function weatherTry(q){
    if(!isWeatherQuestion(q)) return null;

    const coords = await getCoords();
    if(!coords){
      return {
        html: "–ß—Ç–æ–±—ã —Å–∫–∞–∑–∞—Ç—å –ø–æ–≥–æ–¥—É, –º–Ω–µ –Ω—É–∂–Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è (—Ä–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –≤ –±—Ä–∞—É–∑–µ—Ä–µ) –∏–ª–∏ –Ω–∞–ø–∏—à–∏ –≥–æ—Ä–æ–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä: <b>‚Äú–ø–æ–≥–æ–¥–∞ –∑–∞–≤—Ç—Ä–∞ –≤ –ú–∏–Ω—Å–∫–µ‚Äù</b>.",
        meta: null
      };
    }

    const data = await fetchWeatherByCoords(coords.lat, coords.lon);
    if(!data) return { html: "–ù–µ —Å–º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.", meta: null };

    if(isTomorrowWeather(q)){
      return { html: renderTomorrowWeather(data), meta: null };
    }

    // –µ—Å–ª–∏ –±–µ–∑ ‚Äú–∑–∞–≤—Ç—Ä–∞‚Äù ‚Äî –ø–æ–∫–∞–∂–µ–º —Å–µ–≥–æ–¥–Ω—è
    const idx = 0;
    const date = data.daily.time[idx];
    const tMax = data.daily.temperature_2m_max[idx];
    const tMin = data.daily.temperature_2m_min[idx];
    const p = data.daily.precipitation_probability_max[idx];

    return {
      html: `
<b>–ü–æ–≥–æ–¥–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (${esc(date)}):</b>
‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${esc(String(tMin))}‚Ä¶${esc(String(tMax))} ¬∞C<br>
‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Å–∞–¥–∫–æ–≤: ${esc(String(p ?? "‚Äî"))}%<br>
<div class="meta">–ò—Å—Ç–æ—á–Ω–∏–∫: Open-Meteo (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –∫–ª—é—á–µ–π)</div>
`.trim(),
      meta: null
    };
  }

  // ---------------- 6) Wikipedia fallback (—Å—Ç—Ä–æ–∂–µ) ----------------
  const WIKI_STOP = new Set(["–∞–ª–æ","–∞–ª–∞","–∞–≥–∞","–æ–∫","ok","–ª–æ–ª","—Ö–∞—Ö–∞","–ø—Ä–∏–≤–µ—Ç","hi","hello","test","—Ç–µ—Å—Ç","–¥–µ–Ω—å"]);
  function isWikiCandidate(q){
    const s=q.trim().toLowerCase();
    if(s.length < 8) return false;              // –∫–æ—Ä–æ—Ç–∫–æ–µ ‚Äî –Ω–µ –≤–∏–∫–∏
    if(!s.includes(" ") && s.length < 12) return false; // –æ–¥–Ω–æ —Å–ª–æ–≤–æ –∫–æ—Ä–æ—Ç–∫–æ–µ ‚Äî –Ω–µ –≤–∏–∫–∏
    if(WIKI_STOP.has(s)) return false;
    if(/^[0-9+\-*/(). √ó√∑]+$/.test(s)) return false;
    if(isCode(q)) return false;
    if(isWeatherQuestion(q)) return false;
    return true;
  }

  async function wikiTry(q){
    if(!isWikiCandidate(q)) return null;

    try{
      const url="https://ru.wikipedia.org/api/rest_v1/page/summary/"+encodeURIComponent(q);
      const r=await fetch(url);
      if(!r.ok) return null;
      const j=await r.json();
      if(!j.extract) return null;

      const text = j.extract.split(/(?<=\.)\s+/).slice(0,4).join(" ");
      const link = j.content_urls?.desktop?.page;

      return {
        html: esc(text),
        meta: link ? `–ò—Å—Ç–æ—á–Ω–∏–∫: <a href="${link}" target="_blank" rel="noopener noreferrer">Wikipedia</a>` : "–ò—Å—Ç–æ—á–Ω–∏–∫: Wikipedia"
      };
    }catch{
      return null;
    }
  }

  // ---------------- 7) LLM (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–ª–æ–π ‚Äú–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞‚Äù) ----------------
  let generator = null;

  setStatus("–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏‚Ä¶");
  msg("–ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å‚Ä¶ –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ª–≥–∏–º (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ –∫—ç—à).", "bot");

  try{
    generator = await pipeline("text-generation", MODEL);
    setStatus("–≥–æ—Ç–æ–≤");
    msg("–ì–æ—Ç–æ–≤–æ. –ü–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–π –∫–æ–¥.", "bot", `–ú–æ–¥–µ–ª—å: <b>${esc(MODEL)}</b>`);
  }catch(e){
    setStatus("–æ—à–∏–±–∫–∞ –º–æ–¥–µ–ª–∏");
    msg(`<b>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å</b>\n\n<pre><code>${esc(String(e))}</code></pre>\n\n–û—Ç–∫—Ä–æ–π —Å–∞–π—Ç –≤ Chrome/Edge –∏ –æ–±–Ω–æ–≤–∏ Ctrl+F5.`, "bot");
  }

  function buildPrompt(userText){
    // –ñ—ë—Å—Ç–∫–∏–π, —á—Ç–æ–±—ã –º–æ–¥–µ–ª—å –Ω–µ ‚Äú—Å–¥–∞–≤–∞–ª–∞—Å—å‚Äù
    if(isCode(userText)){
      return [
        "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.",
        "–ù–µ –ø–∏—à–∏ '–Ω–µ –º–æ–≥—É'. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ä–µ—à–µ–Ω–∏–µ –∏–ª–∏ –ø–ª–∞–Ω.",
        "–§–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–≥–æ:",
        "1) –†–µ—à–µ–Ω–∏–µ (–∫–æ–¥) –≤ ``` ```",
        "2) –ü–æ—è—Å–Ω–µ–Ω–∏–µ 1-5 –ø—É–Ω–∫—Ç–æ–≤",
        "–ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî –∑–∞–¥–∞–π 1 –≤–æ–ø—Ä–æ—Å.",
        "",
        "–ó–∞–ø—Ä–æ—Å:",
        userText,
        "",
        "–û—Ç–≤–µ—Ç:"
      ].join("\n");
    }

    return [
      "–¢—ã —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.",
      "–û—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏. –ö—Ä–∞—Ç–∫–æ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ.",
      "–ù–µ –ø–∏—à–∏ '–Ω–µ —Å–º–æ–≥'. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ–±—â–∏–π ‚Äî –¥–∞–π –æ–±—â–∏–π –æ—Ç–≤–µ—Ç + –ø—Ä–∏–º–µ—Ä.",
      "",
      "–í–æ–ø—Ä–æ—Å:",
      userText,
      "",
      "–û—Ç–≤–µ—Ç:"
    ].join("\n");
  }

  function renderLLM(text){
    const safe = esc(text || "").trim();
    if(!safe) return null;

    // –§–∏–ª—å—Ç—Ä ‚Äú—Å–¥–∞–ª—Å—è‚Äù / –ø—É—Å—Ç—ã–µ –æ—Ç–ø–∏—Å–∫–∏
    const lower = safe.toLowerCase();
    const gaveUp = (
      lower.includes("–Ω–µ —Å–º–æ–≥") ||
      lower.includes("–Ω–µ –º–æ–≥—É") ||
      lower.includes("—É—Ç–æ—á–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å") && safe.length < 80
    );
    if(gaveUp) return null;

    return safe.replace(/```([\s\S]*?)```/g, (m,g1)=>`<pre><code>${g1}</code></pre>`);
  }

  // ---------------- send() —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ ----------------
  async function send(){
    const text=input.value.trim();
    if(!text) return;

    input.value=""; autoResize();
    msg(esc(text), "user");

    // 1) –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞
    const m = mathTry(text);
    if(m !== null){
      msg("–û—Ç–≤–µ—Ç: " + esc(String(m)), "bot");
      return;
    }

    // 2) –ª–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    const sys = systemAnswer(text);
    if(sys){
      msg(esc(sys), "bot");
      return;
    }

    // 3) –ø–æ–≥–æ–¥–∞ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
    const w = await weatherTry(text);
    if(w){
      msg(w.html, "bot", w.meta);
      return;
    }

    // 4) –º–∏–Ω–∏-–±–∞–∑–∞ Python
    const py = pythonKB(text);
    if(py){
      msg(py.html, "bot", py.meta);
      return;
    }

    // 5) LLM
    if(generator){
      setStatus("–¥—É–º–∞—é‚Ä¶");
      const thinking = msg("–î—É–º–∞—é‚Ä¶", "bot");

      try{
        const prompt = buildPrompt(text);

        const out = await generator(prompt,{
          max_new_tokens: 520,
          temperature: 0.55,
          top_p: 0.9,
          do_sample: true,
          return_full_text: false
        });

        const gen = out?.[0]?.generated_text ?? "";
        const rendered = renderLLM(gen);

        thinking.parentElement.remove();
        setStatus("–≥–æ—Ç–æ–≤");

        if(rendered){
          msg(rendered, "bot");
          return;
        }
      }catch(e){
        thinking.parentElement.remove();
        setStatus("–≥–æ—Ç–æ–≤");
        msg(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: <pre><code>${esc(String(e))}</code></pre>`, "bot");
      }
    }

    // 6) Wikipedia fallback
    const wiki = await wikiTry(text);
    if(wiki){
      msg(wiki.html, "bot", wiki.meta);
      return;
    }

    msg("–Ø –Ω–µ —Å–º–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å. –°–ø—Ä–æ—Å–∏ –∏–Ω–∞—á–µ –∏–ª–∏ –¥–æ–±–∞–≤—å –¥–µ—Ç–∞–ª–µ–π.", "bot");
  }
</script>
</body>
</html>
