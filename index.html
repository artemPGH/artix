<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARTIX</title>
  <style>
    * { box-sizing: border-box; }

    :root {
      --bg1: #050716;
      --bg2: #020308;
      --card: rgba(8, 10, 26, 0.96);
      --panel: rgba(15, 23, 42, 0.92);
      --border: rgba(148, 163, 184, 0.35);
      --border2: rgba(30, 64, 175, 0.45);
      --text: #e5e7eb;
      --muted: rgba(229, 231, 235, 0.70);
      --muted2: rgba(229, 231, 235, 0.55);
      --user: linear-gradient(135deg, rgba(59,130,246,.35), rgba(8,47,73,.9));
      --bot: linear-gradient(135deg, rgba(16,185,129,.22), rgba(15,23,42,.95));
      --btn: linear-gradient(135deg, #4f46e5, #06b6d4);
    }

    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(circle at top, var(--bg1), var(--bg2) 60%, #000);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
    }

    /* Fullscreen layout */
    .page {
      height: 100%;
      display: flex;
      padding: 14px;
    }

    .app {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 18px;
      box-shadow: 0 0 40px rgba(0,0,0,.8), 0 0 80px rgba(88,166,255,.16);
      overflow: hidden;
      min-width: 0;
    }

    .header {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      background: rgba(8, 10, 26, 0.98);
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .title {
      font-size: 22px;
      letter-spacing: .16em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .subtitle {
      font-size: 12px;
      opacity: .70;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status {
      font-size: 12px;
      opacity: .70;
      white-space: nowrap;
    }

    .chat {
      flex: 1;
      background: var(--panel);
      border-top: 1px solid rgba(255,255,255,0.04);
      border-bottom: 1px solid rgba(255,255,255,0.04);
      overflow-y: auto;
      padding: 14px;
    }

    .msg {
      margin-bottom: 10px;
      line-height: 1.4;
      display: flex;
    }
    .msg.user { justify-content: flex-end; }
    .msg.bot { justify-content: flex-start; }

    .bubble {
      max-width: min(860px, 92%);
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.07);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .msg.user .bubble { background: var(--user); }
    .msg.bot .bubble { background: var(--bot); }

    .source {
      margin-top: 8px;
      font-size: 11px;
      opacity: .55;
    }
    .source a { color: #9ecbff; text-decoration: none; }
    .source a:hover { text-decoration: underline; }

    pre {
      margin: 10px 0 4px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15,23,42,.95);
      border: 1px solid rgba(75,85,99,.7);
      overflow-x: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    .composer {
      padding: 12px;
      background: rgba(8, 10, 26, 0.98);
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    textarea {
      flex: 1;
      resize: none;
      min-height: 46px;
      max-height: 220px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,.95);
      color: var(--text);
      outline: none;
      font-size: 14px;
      line-height: 1.35;
    }

    textarea::placeholder {
      color: rgba(148,163,184,.85);
    }

    button {
      padding: 10px 16px;
      border-radius: 12px;
      border: none;
      background: var(--btn);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    button:hover { box-shadow: 0 0 14px rgba(59,130,246,.6); transform: translateY(-1px); }
    button:active { transform: translateY(0); box-shadow: none; }

    .hint {
      padding: 0 12px 12px;
      font-size: 11px;
      opacity: .65;
      background: rgba(8, 10, 26, 0.98);
    }

    @media (max-width: 620px) {
      .page { padding: 10px; }
      .title { font-size: 18px; }
      .status { display: none; }
      .chat { padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="app">
      <div class="header">
        <div class="brand">
          <div class="title">ARTIX</div>
          <div class="subtitle">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: –≤–æ–ø—Ä–æ—Å—ã + –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
        </div>
        <div class="status" id="status">–≥–æ—Ç–æ–≤</div>
      </div>

      <div class="chat" id="chat"></div>

      <div class="composer">
        <textarea id="input" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ... (Enter = –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter = –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)"></textarea>
        <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>

      <div class="hint">
        –ü—Ä–∏–º–µ—Ä—ã: ‚Äú–∫–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å?‚Äù, ‚Äú—á—Ç–æ —Ç–∞–∫–æ–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è?‚Äù, ‚Äú–∏—Å–ø—Ä–∞–≤—å –∫–æ–¥: x = 10 y = &quot;5&quot; z = x + y‚Äù
      </div>
    </div>
  </div>

<script>
  // ---------------- UI helpers ----------------
  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const statusEl = document.getElementById("status");

  function setStatus(text) { statusEl.textContent = text; }

  function addMessage(text, role = "bot", source = null) {
    const msg = document.createElement("div");
    msg.className = `msg ${role}`;

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = text; // we control content (sanitized where needed)

    if (source && source.url) {
      const s = document.createElement("div");
      s.className = "source";
      s.innerHTML = `–∏—Å—Ç–æ—á–Ω–∏–∫: <a href="${source.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(source.label || "link")}</a>`;
      bubble.appendChild(s);
    }

    msg.appendChild(bubble);
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // Auto-resize textarea
  function autoResize() {
    input.style.height = "auto";
    input.style.height = Math.min(input.scrollHeight, 220) + "px";
  }
  input.addEventListener("input", autoResize);

  // Enter to send, Shift+Enter newline
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });
  sendBtn.addEventListener("click", handleSend);

  // ---------------- Smart local intents ----------------
  function systemAnswer(q) {
    const s = q.toLowerCase().trim();

    if (/(–∫–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å|–∫–∞–∫–∞—è —Å–µ–≥–æ–¥–Ω—è –¥–∞—Ç–∞)/.test(s)) {
      return new Date().toLocaleDateString("ru-RU", {
        weekday:"long", year:"numeric", month:"long", day:"numeric"
      }) + ".";
    }

    if (/(–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å|—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏)/.test(s)) {
      return "–°–µ–π—á–∞—Å " + new Date().toLocaleTimeString("ru-RU", { hour:"2-digit", minute:"2-digit" }) + ".";
    }

    if (/(–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|—Ö–∞–π|hello)/.test(s)) {
      return "–ü—Ä–∏–≤–µ—Ç! –ú–æ–≥—É –æ–±—ä—è—Å–Ω—è—Ç—å –ø–æ–Ω—è—Ç–∏—è –∏ –ø–æ–º–æ–≥–∞—Ç—å —Å –∫–æ–¥–æ–º. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å —Å–≤–æ–π –∫–æ–¥ –∏ –ø–æ–ø—Ä–æ—Å–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å.";
    }

    if (/(–∫–∞–∫ –¥–µ–ª–∞|–∫–∞–∫ —Ç—ã)/.test(s)) {
      return "–ù–æ—Ä–º–∞–ª—å–Ω–æ üôÇ –°–∫–∏–¥—ã–≤–∞–π –∑–∞–¥–∞—á—É –∏–ª–∏ –∫–æ–¥ ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º.";
    }

    if (/(—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é)/.test(s)) {
      return "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞!";
    }

    return null;
  }

  // ---------------- Very small programming helper (Python-focused, but single mode) ----------------
  function looksLikeCodeQuestion(q) {
    const s = q.toLowerCase();
    return (
      s.includes("–∏—Å–ø—Ä–∞–≤—å") ||
      s.includes("–æ—à–∏–±–∫–∞") ||
      s.includes("traceback") ||
      s.includes("syntaxerror") ||
      s.includes("typeerror") ||
      s.includes("print(") ||
      s.includes("=") ||
      s.includes("def ") ||
      s.includes("class ")
    );
  }

  function fixSimplePython(codeText) {
    // Heuristic fixes:
    // 1) if assignments are stuck in one line: "x = 10 y = '5' z = x + y"
    // 2) if int + str: convert str to int or int to str based on context
    let s = codeText;

    // If user wrote everything in one line separated by spaces, attempt to split at patterns " <name> ="
    // Example: "x = 10 y = '5' z = x + y print(z) print('done')"
    s = s.replace(/\s+([a-zA-Z_]\w*)\s*=/g, "\n$1 =");

    // Fix common: z = x + y where y is a quoted number
    // If we see y = "5" and later x + y -> convert y to int(y)
    const hasYStringNum = /(^|\n)\s*y\s*=\s*["']\d+["']\s*(\n|$)/m.test(s);
    const hasXNum = /(^|\n)\s*x\s*=\s*\d+\s*(\n|$)/m.test(s);
    const hasZXY = /(^|\n)\s*z\s*=\s*x\s*\+\s*y\s*(\n|$)/m.test(s);

    if (hasYStringNum && hasXNum && hasZXY) {
      s = s.replace(/(^|\n)\s*z\s*=\s*x\s*\+\s*y\s*(\n|$)/m, (m, p1, p2) => `${p1}z = x + int(y)${p2}`);
    }

    // Ensure prints are on their own line (common)
    s = s.replace(/\s+print\s*\(/g, "\nprint(");

    return s.trim();
  }

  function localCodeReply(q) {
    // Extract code: after "–∏—Å–ø—Ä–∞–≤—å" or raw code lines
    const raw = q.replace(/^–∏—Å–ø—Ä–∞–≤—å\s*/i, "").trim();
    if (!raw) return null;

    const fixed = fixSimplePython(raw);

    // If nothing changed, still provide a template suggestion
    const changed = fixed !== raw;
    const explanation = changed
      ? "–Ø —Ä–∞–∑–¥–µ–ª–∏–ª –≤—ã—Ä–∞–∂–µ–Ω–∏—è –ø–æ —Å—Ç—Ä–æ–∫–∞–º –∏ –ø–æ–ø—Ä–∞–≤–∏–ª —Ç–∏–ø—ã (—Å—Ç—Ä–æ–∫–∞/—á–∏—Å–ª–æ) –≤ —Å–ª–æ–∂–µ–Ω–∏–∏."
      : "–Ø –Ω–µ –≤–∏–∂—É —è–≤–Ω–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏. –ï—Å–ª–∏ –µ—Å—Ç—å traceback ‚Äî –≤—Å—Ç–∞–≤—å –µ–≥–æ —Å—é–¥–∞, –∏ —è –ø–æ–¥—Å–∫–∞–∂—É, –≥–¥–µ –ø—Ä–æ–±–ª–µ–º–∞.";

    return `
<b>–í–æ–∑–º–æ–∂–Ω—ã–π —Ñ–∏–∫—Å:</b>
<pre><code>${escapeHtml(fixed)}</code></pre>
<b>–ü–æ—è—Å–Ω–µ–Ω–∏–µ:</b> ${escapeHtml(explanation)}
`.trim();
  }

  // ---------------- Retrieval: Wikipedia, DuckDuckGo, StackOverflow ----------------
  function tokenize(text) {
    return text.toLowerCase().split(/[^a-zA-Z–∞-—è–ê-–Ø0-9_]+/u).filter(Boolean);
  }

  // Wikipedia: search title -> summary (extract)
  async function fetchWikipediaSummary(query) {
    const searchUrl = "https://ru.wikipedia.org/w/rest.php/v1/search/title?limit=1&q=" + encodeURIComponent(query);
    const searchRes = await fetch(searchUrl);
    if (!searchRes.ok) return null;
    const searchData = await searchRes.json();
    if (!searchData.pages || !searchData.pages.length) return null;

    const title = searchData.pages[0].title;
    const summaryUrl = "https://ru.wikipedia.org/api/rest_v1/page/summary/" + encodeURIComponent(title);
    const sumRes = await fetch(summaryUrl);
    if (!sumRes.ok) return null;
    const sum = await sumRes.json();

    if (!sum.extract) return null;

    // Take first ~4 sentences
    const sentences = sum.extract.split(/(?<=\.)\s+/).slice(0, 4).join(" ");
    const url = sum.content_urls?.desktop?.page;

    return {
      text: sentences,
      title: sum.title,
      source: { label: "Wikipedia", url }
    };
  }

  // DuckDuckGo Instant Answer (via allorigins because direct CORS often blocks)
  async function fetchDuckDuckGoIA(query) {
    // DuckDuckGo IA: https://api.duckduckgo.com/?q=...&format=json&no_redirect=1&no_html=1
    // We'll use allorigins to avoid CORS:
    const api = "https://api.duckduckgo.com/?format=json&no_redirect=1&no_html=1&q=" + encodeURIComponent(query);
    const proxied = "https://api.allorigins.win/raw?url=" + encodeURIComponent(api);

    const res = await fetch(proxied);
    if (!res.ok) return null;
    const data = await res.json();

    // Prefer AbstractText, then Answer
    const text = (data.AbstractText || data.Answer || "").trim();
    const url = (data.AbstractURL || "").trim();

    if (!text) return null;
    return {
      text: text.length > 800 ? text.slice(0, 800) + "‚Ä¶" : text,
      title: data.Heading || "–û—Ç–≤–µ—Ç",
      source: url ? { label: "DuckDuckGo", url } : null
    };
  }

  async function fetchStackOverflow(query) {
    const apiUrl =
      "https://api.stackexchange.com/2.3/search/advanced" +
      "?order=desc&sort=relevance" +
      "&answers=1" +
      "&site=stackoverflow" +
      "&pagesize=1" +
      "&q=" + encodeURIComponent(query);

    const res = await fetch(apiUrl);
    if (!res.ok) return null;
    const data = await res.json();
    if (!data.items || !data.items.length) return null;

    const item = data.items[0];
    return {
      text: `–Ø –Ω–∞—à—ë–ª –ø–æ—Ö–æ–∂–µ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ: ‚Äú${item.title}‚Äù. –û–±—ã—á–Ω–æ —Ç–∞–º –µ—Å—Ç—å —Ä–∞–∑–±–æ—Ä –ø—Ä–∏—á–∏–Ω—ã –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.`,
      title: item.title,
      source: { label: "StackOverflow", url: item.link }
    };
  }

  function formatRetrieved(result) {
    const title = result.title ? `<b>${escapeHtml(result.title)}</b><br><br>` : "";
    const body = escapeHtml(result.text || "");
    return `${title}${body}`;
  }

  // ---------------- Main send ----------------
  async function handleSend() {
    const q = input.value.trim();
    if (!q) return;

    addMessage(escapeHtml(q), "user");
    input.value = "";
    autoResize();

    // 1) Local ‚Äúsmart‚Äù answers
    const sys = systemAnswer(q);
    if (sys) {
      addMessage(escapeHtml(sys), "bot");
      return;
    }

    // 2) Local code helper (fix python etc.)
    if (looksLikeCodeQuestion(q)) {
      const localFix = localCodeReply(q);
      if (localFix) {
        addMessage(localFix, "bot");
        return;
      }
    }

    // 3) Web retrieval
    setStatus("–∏—â—É‚Ä¶");
    addMessage("–ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é‚Ä¶", "bot");
    const thinkingNode = chat.lastChild;

    try {
      let best = null;

      // If it looks like programming, try StackOverflow first
      if (looksLikeCodeQuestion(q)) {
        best = await fetchStackOverflow(q);
      }

      // DuckDuckGo IA (if available)
      if (!best) {
        best = await fetchDuckDuckGoIA(q);
      }

      // Wikipedia as fallback (very stable)
      if (!best) {
        best = await fetchWikipediaSummary(q);
      }

      thinkingNode.remove();

      if (best) {
        addMessage(formatRetrieved(best), "bot", best.source);
      } else {
        addMessage("–Ø –Ω–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å (–∏–ª–∏ –¥–æ–±–∞–≤—å –¥–µ—Ç–∞–ª–∏/–∫–æ–Ω—Ç–µ–∫—Å—Ç).", "bot");
      }
    } catch (e) {
      thinkingNode.remove();
      addMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.", "bot");
    } finally {
      setStatus("–≥–æ—Ç–æ–≤");
    }
  }

  // Greeting
  addMessage("–ü—Ä–∏–≤–µ—Ç! –Ø ARTIX. –ü–∏—à–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–π –∫–æ–¥ ‚Äî –ø–æ–ø—Ä–æ–±—É—é –ø–æ–º–æ—á—å –∏/–∏–ª–∏ –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.", "bot");
</script>
</body>
</html>
